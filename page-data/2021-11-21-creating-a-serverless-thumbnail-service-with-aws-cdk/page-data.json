{"componentChunkName":"component---src-templates-blog-post-js","path":"/2021-11-21-creating-a-serverless-thumbnail-service-with-aws-cdk/","result":{"data":{"site":{"siteMetadata":{"title":"Lukas Steinbrecher","author":"Lukas Steinbrecher"}},"markdownRemark":{"id":"071686f7-403a-5037-83ba-69a480bb434b","excerpt":"This article describes how to build a service that automatically creates thumbnails of uploaded pictures that can, for example, be used for a blog. To create…","timeToRead":10,"html":"<p>This article describes how to build a service that automatically creates thumbnails of uploaded pictures that can, for example, be used for a blog.</p>\n<p>To create our service we will use S3 - the AWS file storage service - to store the pictures and thumbnails, and AWS Lambda - the AWS serverless computing service - to create the thumbnails.\nWhen a user uploads a picture to the source S3 bucket, a lambda function will be triggered, that will execute our code to generate the thumbnails and will put it into a target bucket. The process for doing so is described in the detailed step-by-step manual below.</p>\n<p>To define the cloud resources of our service within AWS, we will use AWS CDK (Cloud development kit, <a href=\"https://aws.amazon.com/de/cdk/\">https://aws.amazon.com/de/cdk/</a>), a new library to write infrastructure code. In this example we will use Typescript as our programming language of choice.</p>\n<p>The final code can be downloaded at <a href=\"https://github.com/lukstei/thumbnail-service-cdk\">https://github.com/lukstei/thumbnail-service-cdk</a>.</p>\n<h3>Getting started with the AWS CDK</h3>\n<p>So what it is AWS CDK?\nIn a nutshell, it is a library for generating a CloudFormation template (which is a JSON file defining our AWS infrastructure) in different languages like Typescript, Python or Java.\nIt is important to understand that when using CDK, the CloudFormation template is generated on the computer locally, which means there is no AWS Service called “CDK”.</p>\n<p>After the CloudFormation template has been created, it can then be uploaded to the AWS CloudFormation service, which creates the described infrastructure in AWS (this works for both the initial creation as well as changes made for reassources that are already in place - further information at <a href=\"https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-updating-stacks-changesets.html\">https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-updating-stacks-changesets.html</a>).</p>\n<p>To get started, we need to learn about a few concepts, that are specific to CDK:</p>\n<ul>\n<li><strong>App:</strong> The root construct, which is a container for one or more stacks.</li>\n<li><strong>Stack:</strong> A stack is a unit of deployment, all resources within a stack are provisioned as a single unit. You can deploy stacks individually or as a group.</li>\n<li><strong>Construct:</strong> The main abstraction unit/building block of a stack. A construct contains one or more logically related resources. There are L1 Constructs, which directly correspond to the resources defined by CloudFormation, and higher order Constructs, which represent one or more resources and may already contain some logic.</li>\n<li><strong>Resource:</strong> Represents an actual entity within AWS, e.g. an EC2 instance or a S3 bucket. Each resource is identified by a unique ARN (Amazon Resource Name).</li>\n<li><strong>Token:</strong> Represents a value that is not known yet. When we, for example, want to pass the ARN of an S3 bucket to a Lambda function, the ARN is only known after the ressource ist created. A token is therefore used as a placeholder (the system uses CloudFormation references) that is resolved in the background automatically upon creation.</li>\n<li><strong>Synthesizing:</strong> Process of executing our CDK code that defines the infrastructure (using CDK Constructs) and generates the CloudFormation template.</li>\n</ul>\n<p>One could ask why even bother learning new concepts when we have our good old CloudFormation templates?\nIn my opinion there are many advantages when using CDK compared to writing CloudFormation templates by hand:</p>\n<ul>\n<li><strong>Familiar tooling and programming language concepts:</strong> I can use my well known tools like the IDE and the tooling it provides (including code auto-completion and refactoring). I can use a programming language I am already familiar with and the CDK integrates it into the provided programming languages constructs, like using variables for references. I can use the package manager to use and create dependencies and use a familiar file structure for my code.</li>\n<li><strong>No need to learn a new schema:</strong> I do not have to learn the nitty-gritty details of a schema like CloudFormation templates to define my infrastructure. I can focus on the “business logic”, i.e. how I want to put together my resources (of course I still need to get familiar with the resource/API constructs provided by the AWS platform)</li>\n<li><strong>Testing:</strong> I can unit test the code as usual, e.g. with Jest</li>\n<li><strong>Compactness and maintainability:</strong> In my example I was able to define the service infrastructure with as little as about 30 lines, which will then transform to a 300 line cloudformation template. I can also leverage the provided abstraction constructs of the chosen programming language. This helps me to define everything with more compact code and makes it more maintainable.</li>\n<li><strong>Fun and fast:</strong> Last but not least, it is just more fun sticking together the different services and getting instant feedback by the type system and IDE, than to mess around with a 300 lines YAML file. Not to mention, I am faster navigating and reading the API definitions in the code (which in our case are Typescript files/types) than browsing a website to read the documentation.</li>\n</ul>\n<h2>Let’s get started</h2>\n<p>To follow this example you will need an AWS account, have the AWS CLI configured and installed the AWS CDK via <code>npm install -g aws-cdk</code>.\nClone the repository from <code>https://github.com/lukstei/thumbnail-service-cdk</code>.</p>\n<p>We will go through each important file and explain the interesting parts on the way.</p>\n<h4>The entry point</h4>\n<p>The first file we look into is <code>bin/cdk-lambda.ts</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-typescript line-numbers\"><code class=\"language-typescript\"><span class=\"token hashbang comment\">#!/usr/bin/env node</span>\n<span class=\"token keyword\">import</span> <span class=\"token string\">'source-map-support/register'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">as</span> cdk <span class=\"token keyword\">from</span> <span class=\"token string\">'@aws-cdk/core'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> CdkThumbnailServiceStack <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../lib/CdkThumbnailServiceStack'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">cdk</span><span class=\"token punctuation\">.</span><span class=\"token function\">App</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">new</span> <span class=\"token class-name\">CdkThumbnailServiceStack</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">,</span> <span class=\"token string\">'CdkThumbnailServiceStack'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    tags<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        app<span class=\"token operator\">:</span> <span class=\"token string\">\"thumbnail-service\"</span><span class=\"token punctuation\">,</span>\n        env<span class=\"token operator\">:</span> <span class=\"token string\">\"dev\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>This defines the entry point of our stack. The CDK will execute this file and all constructs our stack contains to generate the CloudFormation template.</p>\n<p>In our case we only defined one stack <code>CdkThumbnailServiceStack</code>, for which we pass some tags in order to stay organized. AWS resources can be tagged in order to categorize them. When we define a tag for a stack it will get applied to all resources the stack creates.</p>\n<h4>The thumbnail service stack</h4>\n<p>Next, let’s look into the <code>CdkThumbnailServiceStack</code>, which is located in <code>lib-cdk-lambda-stack.ts</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-typescript line-numbers\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">as</span> cdk <span class=\"token keyword\">from</span> <span class=\"token string\">'@aws-cdk/core'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> CfnOutput <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@aws-cdk/core\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> ThumbnailingBucket <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"./ThumbnailingBucket\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CdkThumbnailServiceStack</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">cdk</span><span class=\"token punctuation\">.</span>Stack <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>scope<span class=\"token operator\">:</span> cdk<span class=\"token punctuation\">.</span>Construct<span class=\"token punctuation\">,</span> id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> props<span class=\"token operator\">?</span><span class=\"token operator\">:</span> cdk<span class=\"token punctuation\">.</span>StackProps<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>scope<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">,</span> props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">const</span> thumbnailer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ThumbnailingBucket</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Thumbnailer\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n            name<span class=\"token operator\">:</span> <span class=\"token string\">\"lukstei-pictures2\"</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">new</span> <span class=\"token class-name\">CfnOutput</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"SourceBucketUrl\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n            description<span class=\"token operator\">:</span> <span class=\"token string\">\"Source Bucket\"</span><span class=\"token punctuation\">,</span>\n            value<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">https://s3.console.aws.amazon.com/s3/buckets/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>thumbnailer<span class=\"token punctuation\">.</span>sourceBucket<span class=\"token punctuation\">.</span>bucketName<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">new</span> <span class=\"token class-name\">CfnOutput</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"DestBucketUrl\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n            description<span class=\"token operator\">:</span> <span class=\"token string\">\"Destination Bucket\"</span><span class=\"token punctuation\">,</span>\n            value<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">https://s3.console.aws.amazon.com/s3/buckets/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>thumbnailer<span class=\"token punctuation\">.</span>destBucket<span class=\"token punctuation\">.</span>bucketName<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">new</span> <span class=\"token class-name\">CfnOutput</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"LambdaOut\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n            description<span class=\"token operator\">:</span> <span class=\"token string\">\"Lambda ARN\"</span><span class=\"token punctuation\">,</span>\n            value<span class=\"token operator\">:</span> thumbnailer<span class=\"token punctuation\">.</span>func<span class=\"token punctuation\">.</span>functionArn\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>The <code>CdkThumbnailServiceStack</code> class defines four constructs: our <code>ThumbnailingBucket</code>, which contains our main “logic” and the outputs that are used to output some values after the resources are created.</p>\n<h4>Exploring, how tokens work</h4>\n<p>Here we see an interesting thing: For the <code>LambdaOut</code> output, we are using <code>thumbnailer.func.functionArn</code> to reference the ARN of the Bucket. However, when our stack class is executed in the synthesizing step the ARN is not yet known since the resource is not yet created.</p>\n<p>So how does that work? The answer is, the CDK uses so-called tokens to represent values that are not yet known. When we, for example, try to print out the <code>thumbnailer.func.functionArn</code> we will see something like <code>${Token[TOKEN.220]}</code>, which is how the tokens are represented internally. The nice thing about this concept is you can pass tokens around as if the actual value was already assigned.\nWhen we look at the generated CloudFormation template, we see that our token was rendered as an intrinsic function, which will grab the ARN value of the referenced bucket:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-typescript line-numbers\"><code class=\"language-typescript\"><span class=\"token comment\">// ...</span>\n<span class=\"token string\">\"LambdaOut\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"Description\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Bucket ARN\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Value\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"Fn::GetAtt\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token string\">\"ThumbnailerresizerD404C058\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"Arn\"</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// ...</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>The nice thing about that is that we don’t even have to understand how it works internally, we can just use the value as if it was already assigned. It is even possible to do string concatenation with tokens, e.g. <code>thumbnailer.func.functionArn + \" a string\"</code>, which would render correctly.</p>\n<h4>The ThumbnailingBucket construct</h4>\n<p>As there is not much more “interesting” to see in <code>CdkThumbnailServiceStack</code>, let’s look into the <code>ThumbnailingBucket</code> construct, which is located in <code>lib/ThumbnailingBucket.ts</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-typescript line-numbers\"><code class=\"language-typescript\"><span class=\"token comment\">// ...</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ThumbnailingBucket</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Construct</span> <span class=\"token punctuation\">{</span>\n   <span class=\"token comment\">// ...</span>\n\n   <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>scope<span class=\"token operator\">:</span> Construct<span class=\"token punctuation\">,</span> id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> props<span class=\"token operator\">:</span> ThumbnailingBucketProps <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>scope<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>sourceBucket <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">s3</span><span class=\"token punctuation\">.</span><span class=\"token function\">Bucket</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'sourceBucket'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n            bucketName<span class=\"token operator\">:</span> props<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">,</span>\n            removalPolicy<span class=\"token operator\">:</span> RemovalPolicy<span class=\"token punctuation\">.</span><span class=\"token constant\">DESTROY</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>destBucket <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">s3</span><span class=\"token punctuation\">.</span><span class=\"token function\">Bucket</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'destBucket'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n            bucketName<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>sourceBucket<span class=\"token punctuation\">.</span>bucketName<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">-thumbs</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n            removalPolicy<span class=\"token operator\">:</span> RemovalPolicy<span class=\"token punctuation\">.</span><span class=\"token constant\">DESTROY</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>We define our source and destination S3 buckets.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-typescript line-numbers\"><code class=\"language-typescript\">        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>func <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">lambda_node</span><span class=\"token punctuation\">.</span><span class=\"token function\">NodejsFunction</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'resizer'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n            bundling<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                forceDockerBundling<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n                nodeModules<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'sharp'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            timeout<span class=\"token operator\">:</span> Duration<span class=\"token punctuation\">.</span><span class=\"token function\">minutes</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            memorySize<span class=\"token operator\">:</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span>\n            functionName<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>props<span class=\"token punctuation\">.</span>name<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">-resizer</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n            runtime<span class=\"token operator\">:</span> lambda<span class=\"token punctuation\">.</span>Runtime<span class=\"token punctuation\">.</span><span class=\"token constant\">NODEJS_14_X</span><span class=\"token punctuation\">,</span>\n            environment<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token constant\">DEST_BUCKET</span><span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>destBucket<span class=\"token punctuation\">.</span>bucketName\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>We define our lambda function.</p>\n<p>Here we are using a special construct named <code>NodejsFunction</code>, which automatically bundles the specified JS/TS file and their dependencies into a <code>.zip</code> file, as required by Lambda. This has the advantage that we can define the lambda code in the same package as the CDK code. If this is not wanted we could use the <a href=\"https://docs.aws.amazon.com/cdk/api/latest/docs/aws-lambda-readme.html#aws-lambda-construct-library\" target=\"_blank\">vanilla Lambda <code>Function</code> construct</a>.</p>\n<p>The source code of the lambda function is located in <code>lib/ThumbnailingBucket.resizer.ts</code>. To spare you the details of the lambda code, its function can be summarized on a high level as a function that downloads the file which is passed to our Lambda handler by the S3 notification trigger. It then generates thumbnails using the <code>sharp</code> library and uploads the generated files to the destination bucket.</p>\n<p>In bundling we specify <code>forceDockerBundling</code> because our code depends on a library that uses native dependencies. When we prepare the Lambda <code>.zip</code>, which contains our lambda code + dependencies and use a Mac machine it would not work because the Node Package Manager will only download the Mac binaries. The Lambda is, however, executed on a Linux machine, so we can prepare the <code>.zip</code> inside a docker container that uses the same environment as Lambda and will therefore download the correct binaries.</p>\n<p>In <code>environment</code> we pass the destination bucket name as a parameter, since it is not known beforehand. We could also pass tokens for unknown values here.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-typescript line-numbers\"><code class=\"language-typescript\">        <span class=\"token punctuation\">[</span><span class=\"token string\">\".jpg\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\".jpeg\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\".png\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>suffix <span class=\"token operator\">=></span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>sourceBucket<span class=\"token punctuation\">.</span><span class=\"token function\">addObjectCreatedNotification</span><span class=\"token punctuation\">(</span>\n                <span class=\"token keyword\">new</span> <span class=\"token class-name\">s3notify</span><span class=\"token punctuation\">.</span><span class=\"token function\">LambdaDestination</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> suffix<span class=\"token operator\">:</span> suffix <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<p>We set up notification triggers, which will call our lambda function when pictures are uploaded.</p>\n<p>As we can see, it is possible to loop over an array and execute some CDK logic on it, as we would also in “normal” code do.</p>\n<p>For all resource references we can just use normal variables, e.g. for the <code>LambdaDestination</code> we can pass the Lambda construct we created above. It would also be possible to reference already existing resources, e.g. for Lambdas with <code>const myExistingLambda = lambda.Function.fromFunctionArn(\"arn:aws:lambda:region:account-id:function:function-name\")</code></p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-typescript line-numbers\"><code class=\"language-typescript\">        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>sourceBucket<span class=\"token punctuation\">.</span><span class=\"token function\">grantRead</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>destBucket<span class=\"token punctuation\">.</span><span class=\"token function\">grantWrite</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>The last thing we do is to grant the lambda function permissions to read from the source bucket and to grant write permissions to the destination bucket.\nWe can see it’s pretty easy to work with IAM permissions in CDK because we can use variables to reference resources and also use builtin logic like the <code>grantRead</code> method, which already “knows” which actions to grant.</p>\n<p>The generated service role policy statement for the source bucket looks as expected:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-typescript line-numbers\"><code class=\"language-typescript\"><span class=\"token string\">\"PolicyDocument\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"Version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2012-10-17\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"Statement\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"Action\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"s3:GetObject*\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"s3:GetBucket*\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"s3:List*\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Effect\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Allow\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Resource\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token comment\">/* our source bucket */</span> <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3>Deploying our stack</h3>\n<p>We can run the synthetization with <code>cdk synth</code> to see the generated CloudFormation template.\nTo deploy our stack we can run <code>cdk deploy</code>.</p>\n<p>After it is deployed, we can put a test image into the source bucket and see the generated thumbnails in the destination bucket.\nSeems to work just fine :-)</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9439d08098be480f297d5dbc91c9d29e/c16e2/generated-pictures.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-top: 4em; margin-bottom: 4em; max-width: 1300px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 43.07692307692307%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAJABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHuyE0hf//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEAAQUCX//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABkQAAIDAQAAAAAAAAAAAAAAAAABEBExIf/aAAgBAQABPyFUX0WQ9Ef/2gAMAwEAAgADAAAAEEzP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAHBAAAgICAwAAAAAAAAAAAAAAABEBMSFBcYGh/9oACAEBAAE/EMSa1ZKIvSM7Pk32UlT/2Q=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"generated-pictures\"\n        title=\"\"\n        src=\"/static/9439d08098be480f297d5dbc91c9d29e/985be/generated-pictures.jpg\"\n        srcset=\"/static/9439d08098be480f297d5dbc91c9d29e/74459/generated-pictures.jpg 325w,\n/static/9439d08098be480f297d5dbc91c9d29e/a1d47/generated-pictures.jpg 650w,\n/static/9439d08098be480f297d5dbc91c9d29e/985be/generated-pictures.jpg 1300w,\n/static/9439d08098be480f297d5dbc91c9d29e/4d0db/generated-pictures.jpg 1950w,\n/static/9439d08098be480f297d5dbc91c9d29e/c16e2/generated-pictures.jpg 2444w\"\n        sizes=\"(max-width: 1300px) 100vw, 1300px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h3>Testing our stack</h3>\n<p>We can unit-test our constructs just as any other code we normally write, e.g. with Jest.</p>\n<p>In <code>test/ThumbnailingBucket.test.ts</code> we unit-test our construct:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-typescript line-numbers\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Stack <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@aws-cdk/core'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> ThumbnailingBucket <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"../lib/ThumbnailingBucket\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token string\">'@aws-cdk/assert/jest'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> SynthUtils <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@aws-cdk/assert\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ThumbnailingBucket'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> stack <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Stack</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">new</span> <span class=\"token class-name\">ThumbnailingBucket</span><span class=\"token punctuation\">(</span>stack<span class=\"token punctuation\">,</span> <span class=\"token string\">'Subject'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n        name<span class=\"token operator\">:</span> <span class=\"token string\">\"blog-pictures\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"defines exactly two buckets\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>stack<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toCountResources</span><span class=\"token punctuation\">(</span><span class=\"token string\">'AWS::S3::Bucket'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sets the correct policies\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>SynthUtils<span class=\"token punctuation\">.</span><span class=\"token function\">subset</span><span class=\"token punctuation\">(</span>stack<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>resourceTypes<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"AWS::IAM::Policy\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toMatchSnapshot</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>It is possible to use special assertions for the generated template, e.g. <code>toCountResources</code>.</p>\n<p>Snapshot testing is also supported, e.g. we snapshot the generated IAM policies to ensure they won’t change without noticing.</p>\n<p>One shortcoming of the snapshots is, that the generated template contains synthetic values, which depend on the order of the construct. When we move the of <code>grantWrite</code> call before the <code>grantRead</code> call, this will still generate a semantically equivalent policy, however the snapshot will fail because the synthetic ids changed. As of now, I could not find a better way to generate the snapshots, maybe this will change in the future.</p>\n<h2>Conclusion</h2>\n<p>In this article we created a serverless thumbnail service using the AWS CDK. </p>\n<p>What I specifically like about this example is that it contains just the minimal amount of code nedded to express how a service should look like and behave - elegant and without any unnecessary indirections or overhead. I would also argue that even a developer without specific AWS or CloudFormation knowledge can understand what the service is doing by simply reading the code. </p>","frontmatter":{"title":"Creating a serverless thumbnail service with AWS CDK","date":"November 21, 2021","thumbnail":{"childImageSharp":{"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABiUlEQVQoz5VSy0rDUBDNJ/kn/pCge8GCG7tzIYi6SP0BwUdfmwq2tVUkDbahliRN0iY3uXn1OHM1ot15YLiT3Jkzd+aMttlsUFlZlmDc3DaVrYIAnuchjmNIKdWZ5zlkkih/2xL6rzERg8+iKJR/enaJ86tr+L4H0zSxWq1UMJPNPxaIyefibJzDxndhGEKryH6jImY4rgvDMDCdziiuxMH+HhWZqLs0Tf/kiVhAy/MC7tKH47hYr9ewbUeRmM4b1tKH6yxRqx0hoRrF4gXzwx2UowtYto9Ou0W5S0w9A17k0igkNElV3qm6lClO6nX0eo8QIsF41kcgPPhegEZDR0ZNxNYrpse7CJ8aSHKoFsMwUrG2T6MQMTSeg23b6sm6rsOyLLoQ6Ha6mExMJcbzaEQdODRTH81Wm77HP2261M393QMG/QGiKPqaIaNSmMEisGppKpFlGREFqgP+PxwOVVGeOwvBeVyU4xRhtTKVGOxXK5B8rwcnsC/o5UJE6txel8rXsIVtxf+LT18IqzRBfysHAAAAAElFTkSuQmCC","aspectRatio":2.251655629139073,"src":"/static/ae20ac1851389684a5c727d6d2041a59/40a76/service.png","srcSet":"/static/ae20ac1851389684a5c727d6d2041a59/c972b/service.png 340w,\n/static/ae20ac1851389684a5c727d6d2041a59/27625/service.png 680w,\n/static/ae20ac1851389684a5c727d6d2041a59/40a76/service.png 1360w,\n/static/ae20ac1851389684a5c727d6d2041a59/583b1/service.png 1670w","sizes":"(max-width: 1360px) 100vw, 1360px"}}}}},"profileImage":{"childImageSharp":{"fixed":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAQDAgX/xAAXAQEBAQEAAAAAAAAAAAAAAAAAAgED/9oADAMBAAIQAxAAAAH04bZ5qtMnMdjo5B//xAAcEAACAQUBAAAAAAAAAAAAAAAAAQIDBBEiMhL/2gAIAQEAAQUCfNunnKPZR0NkQ6kTk4n/xAAVEQEBAAAAAAAAAAAAAAAAAAAQAf/aAAgBAwEBPwEp/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPwEf/8QAGhABAAIDAQAAAAAAAAAAAAAAAQAQETFRYf/aAAgBAQAGPwJm1PbZ2zE//8QAGhAAAwEBAQEAAAAAAAAAAAAAAAERITFRgf/aAAgBAQABPyFZLM6KLGidTUhlJa5kK0XRtnNbTXwNEp6NE8H/2gAMAwEAAgADAAAAEH//AIP/xAAYEQADAQEAAAAAAAAAAAAAAAABEBEhMf/aAAgBAwEBPxATauiv/8QAGBEBAQEBAQAAAAAAAAAAAAAAAQARIUH/2gAIAQIBAT8QNzlrHkBf/8QAHBABAAIDAAMAAAAAAAAAAAAAAQARITFBUWGB/9oACAEBAAE/EGz6HQ2Y5E0TMATsXqNmyW9FVt8fUDYItXgzGZQKgPMat90+EbSWIuYDfXbZ/9k=","width":27,"height":27,"src":"/static/3f6dadcde453fea67f3c0226d8b431c7/7a3a8/profile-pic-small.jpg","srcSet":"/static/3f6dadcde453fea67f3c0226d8b431c7/7a3a8/profile-pic-small.jpg 1x,\n/static/3f6dadcde453fea67f3c0226d8b431c7/f5261/profile-pic-small.jpg 1.5x,\n/static/3f6dadcde453fea67f3c0226d8b431c7/2da06/profile-pic-small.jpg 2x"}}}},"pageContext":{"slug":"/2021-11-21-creating-a-serverless-thumbnail-service-with-aws-cdk/","previous":{"fields":{"slug":"/2021-03-17-introducing-reddit-hyped-stocks/"},"frontmatter":{"title":"Introducing Reddit Hyped Stocks","date":"March 18, 2021"}},"next":null}},"staticQueryHashes":["63159454"]}